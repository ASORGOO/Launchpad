var BasicMIDI=new function(){this.init=function(t,e,s){return i.init(t,e,s)};var t="newIcons/",i=new function(){var i=100,e=160,o=200,n=900,r=80;this.init=function(i,e,s){return t=s,new l(i,e)};var l=function(t,i){this.player=i,$(t).append('<div class="editor_container"><canvas class="editor_canvas">Your browser does not support the HTML5 canvas tag.</canvas></div>');var e=document.getElementsByClassName("editor_canvas");this.canvas=e[e.length-1],this.context=this.canvas.getContext("2d"),s.init(this.canvas),this.setDimensions(),this.midiWorkspace=h.init(this.canvas,this.width,this.height,r,this);var o=this;$(window).resize(function(){o.setDimensions()}),this.canvas.addEventListener("InputEvent",function(t){o.draw()},!1);var n=setInterval(function(){o.isReady&&(o.draw(),clearInterval(n))},300);this.player.linkEditor(this),console.log("New Editor created")};l.prototype.setDimensions=function(){this.width=Math.max(window.innerWidth-i,n),this.height=Math.max(window.innerHeight-e,o),$(this.canvas).css({width:this.width+"px",height:this.height+"px"}),this.context.width=this.width,this.context.height=this.height,this.canvas.width=this.width,this.canvas.height=this.height,this.midiWorkspace&&this.midiWorkspace.windowResize(this.width,this.height),this.draw()},l.prototype.draw=function(){performance.now();this.context.clearRect(0,0,this.width,this.height),this.context.font="16px arial",this.midiWorkspace&&this.midiWorkspace.draw(this.context);performance.now()},l.prototype.isReady=function(){return this.midiWorkspace.ready()},l.prototype.recordKeyDown=function(t){this.midiWorkspace.recordKeyDown(t)},l.prototype.recordKeyUp=function(t){this.midiWorkspace.recordKeyUp(t)},l.prototype.midiKeyDown=function(t){this.player.midiKeyDown(t)},l.prototype.midiKeyUp=function(t){this.player.midiKeyUp(t)}},e=new function(){var i=4,e=30,s=90,h=30;this.init=function(t,i,e,s){return new o(t,i,e,s)};var o=function(t,i,h,o){console.log("New Header Created"),this.viewWidth=i,this.height=h,this.items=[],this.items.push(new r(e,10,"Play","play.png",o)),this.items.push(new r(e+s,10,"Pause","pause.png",o)),this.items.push(new r(e+2*s,10,"Stop","stop.png",o)),this.items.push(new r(e+3*s,10,"Record","record.png",o)),this.items.push(new r(e+4*s,10,"New","record.png",o)),this.items.push(new r(e+5*s,10,"Save","record.png",o)),this.items.push(new r(e+6*s,10,"Load","record.png",o)),this.items.push(new n(e+7*s,30,3,9,6,"Zoom",o)),this.items.push(new n(e+8*s,30,40,200,140,"BPM",o));var l=this;t.addEventListener("InputEvent",function(t){l.generalInput(t)},!1)};o.prototype.generalInput=function(t){for(var i in this.items)this.items[i].checkMouseOver(t.detail.mouseX,t.detail.mouseY);if(t.detail.mouseDown)for(var i in this.items)this.items[i].checkMouseDown(t.detail);if(t.detail.scrollConsumes>0){t.detail.scrollConsumes--;for(var i in this.items)this.items[i]instanceof n&&this.items[i].smallInc(Math.floor(t.detail.deltaX))}},o.prototype.windowResize=function(t,i){this.viewWidth=t},o.prototype.draw=function(t){t.strokeStyle="rgb(200,200,200)",t.lineWidth=i,t.strokeRect(i/2,i/2,this.viewWidth-i,this.height-i);for(var e in this.items)this.items[e].draw(t)},o.prototype.resetButtons=function(){for(var t in this.items)this.items[t]instanceof r&&(this.items[t].isDown=!1)},o.prototype.isReady=function(){for(var t in this.items)if(!this.items[t].isReady())return!1;return!0};var n=function(t,i,e,s,h,o,n){this.x=t,this.y=i,this.width=60,this.height=20,this.min=e,this.max=s,this.value=h,this.text=o,this.mouseOver=!1,this.midiWorkspace=n};n.prototype.draw=function(t){t.fillStyle="rgb(240,240,240)",t.fillRect(this.x,this.y,this.width,this.height),t.fillStyle="rgb(180,180,180)";var i=(this.value-this.min)/(this.max-this.min)*this.width+this.x;t.beginPath(),t.moveTo(i-h/2,this.y-(h-this.height)/2),t.lineTo(i+h/2,this.y-(h-this.height)/2),t.lineTo(i,this.y+this.height+(h-this.height)/2),t.closePath(),t.fill(),this.mouseOver&&(t.fillStyle="rgb(230,230,30)",t.fillRect(this.x+this.width/2+5,this.y+this.height/2+10,t.measureText(this.text+": "+this.value).width+10,20),t.fillStyle="black",t.fillText(this.text+": "+this.value,this.x+this.width/2+10,this.y+this.height/2+26))},n.prototype.isReady=function(){return!0},n.prototype.checkMouseOver=function(t,i){t>this.x&&t<this.x+this.width&&i>this.y&&i<this.y+this.height?this.mouseOver=!0:this.mouseOver=!1},n.prototype.checkMouseDown=function(t){this.mouseOver&&this.setValue(Math.round(l(t.mouseX,this.x,this.x+this.width,this.min,this.max)))},n.prototype.smallInc=function(t){this.mouseOver&&this.setValue(Math.max(Math.min(this.value+t,this.max),this.min))},n.prototype.setValue=function(t){this.value=t,this.midiWorkspace.sliderChange(this.text,this.value)};var r=function(i,e,s,h,o){this.x=i,this.y=e,this.text=s,this.midiWorkspace=o,this.width=60,this.height=60,this.icon=new Image(this.width,this.height),this.ready=!1,this.mouseOver=!1;var n=this;this.icon.addEventListener("load",function(){n.ready=!0},!1),this.icon.src=t+h,this.isDown=!1};r.prototype.isReady=function(){return this.ready},r.prototype.draw=function(t){this.isDown?t.fillStyle="rgb(100,140,200)":t.fillStyle="rgb(230,230,230)",t.beginPath(),t.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/2,0,0,2*Math.PI),t.fill(),t.drawImage(this.icon,this.x,this.y,this.width,this.height),this.mouseOver&&(t.fillStyle="rgb(230,230,30)",t.fillRect(this.x+this.width/2+5,this.y+this.height/2+10,t.measureText(this.text).width+10,20),t.fillStyle="black",t.fillText(this.text,this.x+this.width/2+10,this.y+this.height/2+26))},r.prototype.checkMouseOver=function(t,i){t>this.x&&t<this.x+this.width&&i>this.y&&i<this.y+this.height?this.mouseOver=!0:this.mouseOver=!1},r.prototype.checkMouseDown=function(t){this.mouseOver&&this.midiWorkspace.buttonPress(this)},r.prototype.changeState=function(t){this.state=t};var l=function(t,i,e,s,h){return(t-i)*(h-s)/(e-i)+s}},s=new function(){this.init=function(i){this.Inputevents=new t(i)};var t=function(t){this.detail={},this.detail.mouseDown=!1,this.detail.mouseDrag=!1,this.detail.mouseX=-1,this.detail.mouseY=-1,this.detail.keyDown=null,this.detail.deltaX=0,this.detail.deltaY=0,this.detail.scrollConsumes=0,this.detail.doubleClickConsumes=0,this.editor=t,this.prevMouseX=-1,this.prevMouseY=-1;var i=this;this.inputEvent=new CustomEvent("InputEvent",{detail:this.detail}),$(this.editor).mousedown(function(t){return i.mouseInputDown(t),!1}),$(this.editor).mouseup(function(t){return i.mouseInputUp(t),!1}),$(this.editor).mousemove(function(t){return i.mouseInputMove(t),!1}),$(this.editor).mouseleave(function(t){return i.mouseInputLeave(t),!1}),$(this.editor).dblclick(function(t){return t.preventDefault(),i.mouseInputDoubleClick(t),!1}),$(document).keydown(function(t){return i.keyInputDown(t),!1}),$(document).keyup(function(t){return i.keyInputUp(t),!1}),this.editor.addEventListener("mousewheel",function(t){return t.preventDefault(),i.mouseInputWheel(t),!1}),console.log("New Input Events")};t.prototype.keyInputDown=function(t){this.detail.keyDown=t.keyCode,this.editor.dispatchEvent(this.inputEvent)},t.prototype.keyInputUp=function(t){this.detail.keyDown=null,this.editor.dispatchEvent(this.inputEvent)},t.prototype.mouseInputLeave=function(t){this.detail.mouseDown=!1,this.detail.mouseX=-1,this.detail.mouseY=-1,this.editor.dispatchEvent(this.inputEvent)},t.prototype.mouseInputDown=function(t){this.detail.mouseX=t.pageX-$(this.editor).offset().left,this.detail.mouseY=t.pageY-$(this.editor).offset().top,this.detail.deltaX=0,this.detail.deltaY=0,this.detail.mouseDown=!0,this.editor.dispatchEvent(this.inputEvent)},t.prototype.mouseInputUp=function(t){this.detail.mouseX=t.pageX-$(this.editor).offset().left,this.detail.mouseY=t.pageY-$(this.editor).offset().top,this.detail.mouseDown=!1,this.prevMouseX=-1,this.prevMouseY=-1,this.detail.mouseDrag=!1,this.editor.dispatchEvent(this.inputEvent)},t.prototype.mouseInputMove=function(t){this.detail.mouseX=t.pageX-$(this.editor).offset().left,this.detail.mouseY=t.pageY-$(this.editor).offset().top,-1!=this.prevMouseX&&(this.detail.deltaX=this.detail.mouseX-this.prevMouseX,this.detail.deltaY=this.detail.mouseY-this.prevMouseY),this.prevMouseX=this.detail.mouseX,this.prevMouseY=this.detail.mouseY,this.detail.mouseDown&&(this.detail.mouseDrag=!0),this.editor.dispatchEvent(this.inputEvent)},t.prototype.mouseInputWheel=function(t){this.detail.deltaX=t.deltaX,this.detail.deltaY=t.deltaY,this.detail.scrollConsumes=2,this.editor.dispatchEvent(this.inputEvent)},t.prototype.mouseInputDoubleClick=function(t){this.detail.doubleClickConsumes=1,this.editor.dispatchEvent(this.inputEvent)}},h=new function(){var t=4,i=30,s=24,h=10,o=16,n=70,l=[1/32,1/16,1/8,.25,.5,1,2,4,8,16,32],a=24,d=26,c=["1","2","3","4","5","6","7","8","9","0","-","=","Q","W","E","R","T","Y","U","I","O","P","[","]","A","S","D","F","G","H","J","K","L",";","'","\\n","Z","X","C","V","B","N","M",",",".","/","\\s","","<",">","^","v"],f=[49,50,51,52,53,54,55,56,57,48,189,187,81,87,69,82,84,89,85,73,79,80,219,221,65,83,68,70,71,72,74,75,76,186,222,13,90,88,67,86,66,78,77,188,190,191,16,-1,37,39,38,40];this.init=function(t,i,e,s,h){return new u(t,i,e,s,h)};var u=function(t,h,o,a,c){this.width=h,this.height=o-a,this.heightOffset=a,this.drawClass=c,this.BPM=140,this.ZoomLevel=0,this.BeatsPerSection=l[this.ZoomLevel+5],this.BeatsToPixels=n/this.BeatsPerSection,this.horizontalOffset=0,this.verticalOffset=0,this.scrubBarAt=0,this.edgeScroll=!1,this.scrollInterval=null,this.maxWidth=this.width,this.noteHandler=r.init(t,s,this.heightOffset+i,this.width-s,this.height-i-d,n,f.length,this);var u=this;t.addEventListener("InputEvent",function(t){u.generalInput(t)},!1),this.isRecording=!1,this.isPlaying=!1,this.header=e.init(t,this.width,this.horizontalOffset,this),console.log("New MIDI Workspace created")};u.prototype.generalInput=function(t){t.detail.scrollConsumes>0&&t.detail.mouseY>this.heightOffset&&(this.canvasScroll(t.detail.deltaX,t.detail.deltaY),t.detail.scrollConsumes--),t.detail.mouseDown?(t.detail.mouseY>this.heightOffset&&t.detail.mouseY<this.heightOffset+i&&(this.scrubBarAt=Math.max(0,(t.detail.mouseX-this.horizontalOffset-s)/this.BeatsToPixels)),t.detail.mouseY>this.height+this.heightOffset-d&&t.detail.mouseX>s&&this.canvasScroll(t.detail.deltaX*(this.maxWidth/this.BeatsPerSection)/this.width,0),this.checkEdgeScroll(t.detail.mouseX,t.detail.mouseY,t.detail.deltaX,t.detail.deltaY)):(null!=this.scrollInterval&&clearInterval(this.scrollInterval),this.edgeScroll=!1)},u.prototype.checkEdgeScroll=function(t,e,h,o){if(2*s>t&&0>h||t>this.width-s&&h>0||e<this.height+this.heightOffset-d&&e>this.height+this.heightOffset-d-s&&o>0||e>this.heightOffset+i&&e<this.heightOffset+i+s&&0>o){if(!this.edgeScroll){this.edgeScroll=!0;var n=this,r=[2];2*s>t?r=[-a,0]:t>this.width-s?r=[a,0]:e<this.height+this.heightOffset-d&&e>this.height+this.heightOffset-d-s?r=[0,a]:e>this.heightOffset+i&&e<this.heightOffset+i+s&&(r=[0,-a]),this.scrollInterval=setInterval(function(){n.canvasScroll(r[0],r[1]),n.drawClass.draw()},100)}}else null!=this.scrollInterval&&clearInterval(this.scrollInterval),this.edgeScroll=!1},u.prototype.canvasScroll=function(e,h){this.horizontalOffset-=e,this.verticalOffset-=h,this.verticalOffset=Math.max(this.verticalOffset,-c.length*s+this.height-i-t-d),this.verticalOffset=Math.min(this.verticalOffset,0),this.horizontalOffset=Math.min(this.horizontalOffset,0),this.horizontalOffset=Math.max(this.horizontalOffset,Math.min(-(this.maxWidth/this.BeatsPerSection)+this.width,0)),this.noteHandler.scroll(this.horizontalOffset,this.verticalOffset)},u.prototype.windowResize=function(t,e){this.width=t,this.height=e-this.heightOffset,this.canvasScroll(0,0),this.noteHandler.windowResize(this.width-s,this.height-i-d),this.header.windowResize()},u.prototype.draw=function(e){var r=Math.ceil(this.width/n)+1;e.strokeStyle="rgb(90,70,70)",e.lineWidth=1;for(var l=0;r>l;l++)e.beginPath(),e.moveTo(l*n+s+this.horizontalOffset%n,this.heightOffset),e.lineTo(l*n+s+this.horizontalOffset%n,this.height+this.heightOffset),e.stroke();this.noteHandler.draw(e);var a=this.scrubBarAt*this.BeatsToPixels+this.horizontalOffset+s;e.strokeStyle="rgb(0,0,220)",e.beginPath(),e.moveTo(a,this.heightOffset+i),e.lineTo(a,this.heightOffset+this.height),e.stroke(),e.fillStyle="rgb(240,240,240)",e.fillRect(0,this.heightOffset,s,this.height),e.fillStyle="black";for(var l=1;l<=c.length;l++){var f=this.heightOffset+i+l*s-6+this.verticalOffset;f>this.heightOffset+i&&f<=this.height+this.heightOffset+s&&e.fillText(c[l-1],8,this.heightOffset+i+l*s-6+this.verticalOffset)}var u=Math.ceil(this.height/s);e.strokeStyle="rgb(90,70,70)";for(var l=1;u>=l;l++)e.beginPath(),e.moveTo(0,this.heightOffset+i+l*s+this.verticalOffset%s),e.lineTo(this.width,this.heightOffset+i+l*s+this.verticalOffset%s),e.stroke();e.fillStyle="rgb(210,210,210)",e.fillRect(0,this.heightOffset,this.width,i),e.fillStyle="black";for(var l=0;r>l;l++){var p=l*n+s+this.horizontalOffset%n;e.beginPath(),e.moveTo(p,this.heightOffset),e.lineTo(p,this.heightOffset+i),e.stroke();for(var g=1;3>=g;g++)e.beginPath(),e.moveTo(p+g*n/4,this.heightOffset+i-4+4*(g%2-1)),e.lineTo(p+g*n/4,this.heightOffset+i),e.stroke();var v=l*this.BeatsPerSection+Math.floor(-1*this.horizontalOffset/n)*this.BeatsPerSection;v==Math.round(v)&&e.fillText(v+"",p+2,this.heightOffset+i-o+t)}e.fillStyle="rgb(0,0,220)",e.strokeStyle="rgb(0,0,220)",e.beginPath(),e.moveTo(a-.6*h,this.heightOffset+o+t),e.lineTo(a+.6*h,this.heightOffset+o+t),e.lineTo(a,this.heightOffset+t+h+o),e.closePath(),e.fill(),e.beginPath(),e.moveTo(a,this.heightOffset+o+t),e.lineTo(a,this.heightOffset+i),e.stroke(),e.fillStyle="rgb(100,100,100)",e.fillRect(s,this.height+this.heightOffset-d,this.width-s,d),e.fillStyle="rgb(200,200,200)",e.fillRect(s+2+this.width/(this.maxWidth/this.BeatsPerSection)*-this.horizontalOffset,this.height+this.heightOffset-d+2,this.width*this.width/(this.maxWidth/this.BeatsPerSection)-s-4-t,d-4-t),e.lineWidth=t,e.strokeStyle="rgb(170,170,170)",e.strokeRect(t/2,this.heightOffset+t/2,this.width-t,this.height-t),this.header.draw(e)},u.prototype.setMaxWidth=function(t){this.maxWidth=t+this.width},u.prototype.buttonPress=function(t){"Record"==t.text?this.isPlaying||(this.isRecording=!this.isRecording,this.header.resetButtons(),t.isDown=this.isRecording,this.isRecording?this.noteHandler.startRecording(this.BPM,this.scrubBarAt):this.scrubBarAt=this.noteHandler.stopRecording()):"Play"==t.text?this.isRecording||this.isPlaying||(this.isPlaying=!0,this.header.resetButtons(),this.noteHandler.startPlaying(this.BPM,this.scrubBarAt),t.isDown=!0):"Pause"==t.text?this.isPlaying&&(this.isPlaying=!1,this.header.resetButtons(),this.noteHandler.stopPlaying(),t.isDown=!0):"Stop"==t.text&&(this.isRecording?this.scrubBarAt=this.noteHandler.stopRecording():this.scrubBarAt=0,this.isPlaying&&this.noteHandler.stopPlaying(),this.isPlaying=!1,this.isRecording=!1,this.noteHandler.beatAt=this.scrubBarAt,this.header.resetButtons(),t.isDown=!0)},u.prototype.sliderChange=function(t,i){"Zoom"==t?(this.ZoomLevel=i-6,this.BeatsPerSection=l[this.ZoomLevel+5],this.BeatsToPixels=n/this.BeatsPerSection,this.noteHandler.changeResolution(this.BeatsPerSection),this.canvasScroll(0,0)):"BPM"==t&&(this.BPM=i)},u.prototype.redrawAll=function(){(this.isPlaying||this.isRecording)&&(this.scrubBarAt=this.noteHandler.beatAt),this.drawClass.draw()},u.prototype.isReady=function(){return this.header.ready()},u.prototype.recordKeyDown=function(t){if(this.isRecording){var i=f.indexOf(t);-1!=i&&this.noteHandler.recordNoteDown(i)}},u.prototype.recordKeyUp=function(t){if(this.isRecording){var i=f.indexOf(t);-1!=i&&this.noteHandler.recordNoteUp(i)}},u.prototype.playKeyDown=function(t){this.drawClass.midiKeyDown(f[t])},u.prototype.playKeyUp=function(t){this.drawClass.midiKeyUp(f[t])}},o=new function(){this.init=function(){return new t};var t=function(){this.isActive=!1,this.x=0,this.y=0,this.sx=0,this.sy=0,this.w=0,this.h=0};t.prototype.startNew=function(t,i,e,s){this.isActive=!0,this.sx=t-e,this.sy=i-s,this.x=this.sx,this.y=this.sy,this.w=0,this.h=0},t.prototype.update=function(t,i,e,s){t-e>this.sx?(this.x=this.sx,this.w=t-(this.x+e)):(this.x=t-e,this.w=this.sx-this.x),i-s>this.sy?(this.y=this.sy,this.h=i-(this.y+s)):(this.y=i-s,this.h=this.sy-this.y)},t.prototype.noteInMulti=function(t){return t.px+t.pw>this.x&&t.px<this.x+this.w&&t.py+t.height>this.y&&t.py<this.y+this.h},t.prototype.draw=function(t,i,e,s){if(this.isActive){t.globalAlpha=.3,t.fillStyle="rgb(50,50,240)";var h=this.y+e,o=this.h;s>h&&(o-=s-h,h=s),t.fillRect(this.x+i,h,this.w,o),t.globalAlpha=1}}},n=new function(){this.createNote=function(i,e,s,h,o,n,r){return new t(i,e,s,h,o,n,r)};var t=function(t,i,e,s,h,o,n){this.note=t,this.beat=i,this.length=e,this.height=s,this.px=h*this.beat+o,this.py=s*this.note+n,this.deltaX=0,this.deltaY=0,this.deltaWidth=0,this.pw=h*this.length,this.selected=!1,this.minResizePadding=15,this.radius=6};t.prototype.draw=function(t,i,e){this.selected?t.fillStyle="rgb(100,140,200)":t.fillStyle="rgb(168,214,238)",t.stokeStyle="rgb(190,235,255)";var s=this.px+i,h=this.py+e;t.beginPath(),t.moveTo(s+this.radius,h),t.lineTo(s+this.pw-this.radius,h),t.quadraticCurveTo(s+this.pw,h,s+this.pw,h+this.radius),t.lineTo(s+this.pw,h+this.height-this.radius),t.quadraticCurveTo(s+this.pw,h+this.height,s+this.pw-this.radius,h+this.height),t.lineTo(s+this.radius,h+this.height),t.quadraticCurveTo(s,h+this.height,s,h+this.height-this.radius),t.lineTo(s,h+this.radius),t.quadraticCurveTo(s,h,s+this.radius,h),t.closePath(),t.stroke(),t.fill()},t.prototype.mouseOver=function(t,i){return t>this.px&&t<this.px+this.pw&&i>this.py&&i<this.py+this.height?!0:!1},t.prototype.adjustLength=function(t,i){this.pw=t*this.length,this.px=this.beat*t+i},t.prototype.moveNote=function(t,i){this.deltaX+=t,this.deltaY+=i,this.px+=t,this.py+=i},t.prototype.rightResize=function(t){this.pw+t>1&&(this.deltaWidth+=t,this.pw+=t)},t.prototype.leftResize=function(t){this.pw-t>1&&(this.deltaX+=t,this.px+=t,this.deltaWidth-=t,this.pw-=t)},t.prototype.overLeftEdge=function(t,i){return this.pw>this.minResizePadding&&t>this.px&&t<this.px+this.pw/3&&i>this.py&&i<this.py+this.height?!0:!1},t.prototype.overRightEdge=function(t,i){return this.pw>this.minResizePadding&&t>this.px+this.pw-this.pw/3&&t<this.px+this.pw&&i>this.py&&i<this.py+this.height?!0:!1},t.prototype.mouseUp=function(t,i,e,s,h){var o=Math.round(4*this.deltaX/e)/4,n=Math.round(this.deltaY/i);this.px+=o*e-this.deltaX,this.py+=n*i-this.deltaY,this.deltaX=0,this.deltaY=0,this.beat+=o*t,this.note+=n,this.beat<0&&(this.px+=-this.beat*e,this.beat=0),this.note<0&&(this.py+=-this.note*i,this.note=0),this.note>=h&&(this.py+=(h-1-this.note)*i,this.note=h-1);var r=Math.round(4*this.deltaWidth/e)/4;this.pw+=r*e-this.deltaWidth,this.deltaWidth=0,this.length+=r*t,this.length<=0&&(this.length=t/4,this.pw=s*this.length)},t.prototype.isVisible=function(t,i,e,s,h,o){return this.px+this.pw+h>t&&this.px+h<t+e&&this.py+this.height+o>i&&this.py+o<i+s?!0:!1}},r=new function(){this.init=function(i,e,s,h,o,n,r,l){return new t(i,e,s,h,o,n,r,l)};var t=function(i,e,s,h,n,r,a,d){this.x=e,this.y=s,this.width=h,this.height=n,this.PixelsPerSection=r,this.maxKeys=a,this.midiEditor=d,this.notes=[],this.visibleNotes=[],this.beatAt=0,this.resolution=1,this.PixelsPerNote=e,this.PixelsPerBeat=this.PixelsPerSection/this.resolution,this.verticalOffset=0,this.horizontalOffset=0,this.selected=[],this.multiSelect=o.init(),this.selectedMouseUp=!0,this.possibleNewNote=null,this.resizing=-1,this.farthestNote=0,this.selectedSet=!1,l.init(t),this.editor=i;var c=this;this.editor.addEventListener("InputEvent",function(t){c.generalInput(t)},!1),this.recordInterval=null,this.recordStartTime=0,this.recordBeatStart=0,this.recordNoteStart=[],this.MSToBeats=0,this.recordResolution=8,this.playInterval=null,this.playResolution=10,this.notesPlaying=[],console.log("New Note Handler created")};t.prototype.scroll=function(t,i){var e=this.horizontalOffset-t,s=this.verticalOffset-i;if(this.horizontalOffset=t,this.verticalOffset=i,!this.multiSelect.isActive&&!this.selectedMouseUp)for(var h in this.selected)this.selected[h].moveNote(e,s);this.visibleNotes=[];for(var h in this.notes)this.notes[h].isVisible(this.x,this.y,this.width,this.height,this.horizontalOffset,this.verticalOffset)&&this.visibleNotes.push(this.notes[h])},t.prototype.draw=function(t){for(var i in this.visibleNotes)this.visibleNotes[i].draw(t,this.horizontalOffset,this.verticalOffset);this.multiSelect.draw(t,this.horizontalOffset,this.verticalOffset,this.y)},t.prototype.windowResize=function(t,i){this.width=t,this.height=i},t.prototype.changeResolution=function(t){this.resolution=t,this.PixelsPerBeat=this.PixelsPerSection/this.resolution;for(var i in this.notes)this.notes[i].adjustLength(this.PixelsPerBeat,this.x)},t.prototype.findNote=function(t,i,e){for(var s,h,o=0,n=t.length-1;n>=o;)if(s=(o+n)/2|0,h=t[s],h.beat<i.beat)o=s+1;else if(h.beat>i.beat)n=s-1;else{if(e)return s;for(var r=o;n>=r;r++)if(t[r]==i)return r;o++}return e||(console.log("Didn't find note"),console.log(t),console.log(i),console.log(s+","+o+","+n),alert("Critical Error! Didn't find note")),o},t.prototype.startRecording=function(t,i){this.MSToBeats=t/6e4,this.recordStartTime=(new Date).getTime(),this.recordBeatStart=i;var e=this;this.recordInterval=setInterval(function(){e.beatAt=e.recordBeatStart+e.MSToBeats*((new Date).getTime()-e.recordStartTime),e.midiEditor.redrawAll()},100)},t.prototype.stopRecording=function(){return clearInterval(this.recordInterval),this.beatAt=this.recordBeatStart,this.recordNoteStart=[],this.beatAt},t.prototype.recordNoteDown=function(t){var i=!1;for(var e in this.recordNoteStart)this.recordNoteStart[e].note==t&&(i=!0);i||this.recordNoteStart.push({note:t,sTime:(new Date).getTime()})},t.prototype.recordNoteUp=function(t){for(var i=(new Date).getTime(),e=0;e<this.recordNoteStart.length;e++)if(this.recordNoteStart[e].note==t){this.addNewNote(n.createNote(t,Math.round((this.recordBeatStart+(this.recordNoteStart[e].sTime-this.recordStartTime)*this.MSToBeats)*this.recordResolution)/this.recordResolution,Math.max(Math.round((i-this.recordNoteStart[e].sTime)*this.MSToBeats*this.recordResolution)/this.recordResolution,1/this.recordResolution),this.PixelsPerNote,this.PixelsPerBeat,this.x,this.y)),this.recordNoteStart.splice(e,1),e--;break}},t.prototype.startPlaying=function(t,i){this.MSToBeats=t/6e4;var e=this,s=0,h=(new Date).getTime(),o=(new Date).getTime(),n=i,r=-1;for(var l in this.notes)if(this.notes[l].beat>=n){r=l;break}-1==r&&(r=0,n=0),this.playInterval=setInterval(function(){0==e.notesPlaying.length&&r>=e.notes.length&&clearInterval(e.playInterval);var t=(new Date).getTime();for(e.beatAt=n+e.MSToBeats*((new Date).getTime()-h);r<e.notes.length&&e.notes[r].beat<=e.beatAt;)e.notesPlaying.push(r),e.midiEditor.playKeyDown(e.notes[r].note),r++;for(var i=0;i<e.notesPlaying.length;i++)e.notes[e.notesPlaying[i]].beat+e.notes[e.notesPlaying[i]].length<=e.beatAt&&(e.midiEditor.playKeyUp(e.notes[e.notesPlaying[i]].note),e.notesPlaying.splice(i,1),i--);s+=t-o,o=t,s>100&&(s-=100,e.midiEditor.redrawAll())},this.playResolution)},t.prototype.stopPlaying=function(){clearInterval(this.playInterval);for(var t in this.notesPlaying)this.midiEditor.playKeyUp(this.notes[this.notesPlaying[t]].note);this.notesPlaying=[]},t.prototype.addNewNote=function(t){this.notes.splice(this.findNote(this.notes,t,!0),0,t),this.visibleNotes.push(t),t.px+t.pw>this.farthestNote&&(this.farthestNote=t.px+t.pw,this.midiEditor.setMaxWidth(this.farthestNote*this.resolution))}},l=new function(){this.init=function(t){t.prototype.generalInput=function(t){if(t.detail.mouseDown){var i=!1;if(this.multiSelect.isActive){this.multiSelect.update(t.detail.mouseX,t.detail.mouseY,this.horizontalOffset,this.verticalOffset);for(var e in this.visibleNotes)!this.visibleNotes[e].selected&&this.multiSelect.noteInMulti(this.visibleNotes[e])&&(this.selected.push(this.visibleNotes[e]),this.visibleNotes[e].selected=!0);for(var e in this.selected)this.selected[e].selected&&!this.multiSelect.noteInMulti(this.selected[e])&&(this.selected[e].selected=!1,this.selected.splice(e,1));i=!0}else if(0==this.selected.length){for(var e=this.visibleNotes.length-1;e>=0;e--)if(this.visibleNotes[e].mouseOver(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset)){this.visibleNotes[e].selected=!0,this.selected.push(this.visibleNotes[e]),this.selectedMouseUp=!1,this.resizing=0,i=!0;break}}else if(this.selectedMouseUp){for(var e in this.selected)if(this.selected[e].mouseOver(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset)){this.selectedMouseUp=!1;break}}else{if(-1==this.resizing)for(var e in this.selected){if(this.selected[e].overLeftEdge(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset)){this.resizing=1;break}if(this.selected[e].overRightEdge(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset)){this.resizing=2;break}}-1==this.resizing&&(this.resizing=0);for(var e in this.selected)1==this.resizing?this.selected[e].leftResize(t.detail.deltaX):2==this.resizing?this.selected[e].rightResize(t.detail.deltaX):this.selected[e].moveNote(t.detail.deltaX,t.detail.deltaY);this.selectedSet=!1,i=!0}if(!i&&this.selectedMouseUp&&0!=this.selected.length){for(var e in this.selected)this.selected[e].selected=!1;this.selected=[],i=!0}!i&&this.selectedMouseUp&&t.detail.mouseX>this.x&&t.detail.mouseX<this.x+this.width&&t.detail.mouseY>this.y&&t.detail.mouseY<this.y+this.height&&(this.possibleNewNote=n.createNote(Math.floor((t.detail.mouseY-this.y-this.verticalOffset)/this.PixelsPerNote),Math.floor((t.detail.mouseX-this.x-this.horizontalOffset)/this.PixelsPerSection)*this.resolution,this.resolution,this.PixelsPerNote,this.PixelsPerBeat,this.x,this.y))}else if(null!=this.possibleNewNote&&(this.addNewNote(this.possibleNewNote),this.possibleNewNote=null),this.selectedMouseUp=!0,this.multiSelect.isActive=!1,this.resizing=-1,this.selected.length>0){for(var s=!1,h=this.selected.length-1;h>=0;h--)if(this.selected[h].mouseOver(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset)){(this.selected[h].overLeftEdge(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset)||this.selected[h].overRightEdge(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset))&&($(this.editor).css("cursor","col-resize"),s=!0);break}s||$(this.editor).css("cursor","default")}if(27==t.detail.keyDown){for(var e in this.selected)this.selected[e].selected=!1;this.selected=[]}else if(8==t.detail.keyDown){for(var e in this.selected){this.notes.splice(this.notes.indexOf(this.selected[e]),1);var o=this.visibleNotes.indexOf(this.selected[e]);-1!=o&&this.visibleNotes.splice(o,1)}this.selected=[]}if(t.detail.mouseDrag&&(this.possibleNewNote=null,0==this.selected.length&&!this.multiSelect.isActive&&t.detail.mouseY>this.y&&this.multiSelect.startNew(t.detail.mouseX,t.detail.mouseY,this.horizontalOffset,this.verticalOffset)),(!t.detail.mouseDown||t.detail.mouseX<this.x||t.detail.mouseY<this.y||t.detail.mouseY>this.y+this.height)&&!this.selectedSet){for(var e in this.selected)this.notes.splice(this.findNote(this.notes,this.selected[e],!1),1);for(var e in this.selected)this.selected[e].mouseUp(this.resolution,this.PixelsPerNote,this.PixelsPerSection,this.PixelsPerBeat,this.maxKeys),this.notes.splice(this.findNote(this.notes,this.selected[e],!0),0,this.selected[e]);this.selectedSet=!0}if(t.detail.doubleClickConsumes>0){for(var e=this.visibleNotes.length-1;e>=0;e--)if(this.visibleNotes[e].mouseOver(t.detail.mouseX-this.horizontalOffset,t.detail.mouseY-this.verticalOffset)){this.notes.splice(this.notes.indexOf(this.visibleNotes[e]),1),this.visibleNotes.splice(e,1),this.selected.splice(this.selected.indexOf(this.visibleNotes[e]),1);break}t.detail.doubleClickConsumes--}},console.log("Added input function to Note Handler object")}}};